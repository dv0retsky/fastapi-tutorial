|||
|---|---|
|ДИСЦИПЛИНА|Технологии разработки серверных приложений|
|ИНСТИТУТ|ИПТИП|
|КАФЕДРА|Индустриального программирования|
|ВИД УЧЕБНОГО МАТЕРИАЛА|Методические указания к практическим занятиям|
|ПРЕПОДАВАТЕЛЬ|Дворецкий Артур Геннадьевич|
|СЕМЕСТР|4 семестр, 2025/2026 уч. год|

Ссылка на материал: <br>
https://github.com/dv0retsky/fastapi-tutorial/blob/main/FAPI5_Async%20Types%20Cookies/FAPI5_Async%20Types%20Cookies.md

---

# Практическое занятие №6: Реализация аутентификации

**Аутентификация** — это процесс проверки личности пользователя или системы, пытающихся получить доступ к веб-приложению. Другими словами, аутентификация обеспечивает подтверждение того, что перед нами действительно тот, за кого себя выдают.

Чтобы понять этот процесс, представьте ситуацию: вам в мессенджере пишет человек, утверждая, что он ваш друг, и просит занять денег. Однако вы знаете, что настоящий друг сейчас в отпуске без интернета. Чтобы убедиться, что это действительно он, вы задаете вопрос, на который знает ответ только ваш настоящий друг — например, вспоминаете события вечеринки два года назад. Если собеседник не может ответить, становится ясно, что это мошенник. В данном случае вопрос про вечеринку является способом проверки личности, то есть аутентификацией.

В веб-приложениях аутентификация чаще всего реализуется через проверку логина и пароля. Когда пользователь вводит свои учетные данные, сервер проверяет их соответствие сохраненным в базе данных. Если введенные данные верны, пользователь получает доступ к системе. В противном случае доступ отклоняется.

Вот корректная формулировка без упоминания `JWT` и `OAuth`:

**FastAPI** поддерживает стандартные схемы аутентификации (через `OpenAPI`/`Starlette`):

- **HTTP Basic** — базовая проверка логина и пароля.
- **HTTP Bearer** — передача токена в заголовке `Authorization: Bearer …`. 
- **API Key** — ключ приложения в query-параметре, заголовке или `cookie`.
- **OpenID Connect (Discovery)** — подключение внешнего провайдера идентификации по `/.well-known/openid-configuration`. 
- **Сессионные cookie** — сессии на базе Starlette `SessionMiddleware` (удобно для web-логина).

Одним из самых простых подходов является базовая аутентификация, с которой мы и будем работать.

Дополнительные [материалы](https://encyclopedia.kaspersky.ru/glossary/authentication/) по теме!

## Как работает базовая аутентификация?

Базовая аутентификация — это один из самых простых методов проверки подлинности, который используется для защиты ресурсов в веб-приложениях. В этом методе клиент (например, веб-браузер или **API-клиент**) передает свои учетные данные (имя пользователя и пароль) в заголовке HTTP-запроса, в поле `Authorization`. Формат данных в этом заголовке следующий: `Authorization: Basic <credentials>`, где `<credentials>` — это закодированная строка, состоящая из имени пользователя и пароля, разделенных двоеточием. Эта строка кодируется в формате **Base64**.

Пример заголовка запроса с базовой аутентификацией:

```bash
Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=
```

Когда сервер получает запрос, он извлекает и декодирует строку из заголовка, разделяет имя пользователя и пароль, а затем проверяет их на соответствие сохраненным данным. Если введенные данные совпадают с теми, что есть в базе данных или у поставщика аутентификации, сервер предоставляет доступ к защищенному ресурсу. В противном случае, если данные некорректны, сервер отклоняет запрос и отправляет ошибку, обычно с кодом `401 (Unauthorized)`.

**FastAPI** облегчает работу с базовой аутентификацией, предоставляя встроенные компоненты для обработки этого типа аутентификации. Это позволяет значительно упростить процесс реализации и интеграции базовой аутентификации в ваше приложение.

## Реализация базовой аутентификации в FastAPI

Чтобы реализовать базовую аутентификацию в **FastAPI**, нужно выполнить несколько простых шагов:

**Шаг 1: Импорт зависимостей**

```python
from fastapi import FastAPI, Depends, status, HTTPException
from pydantic import BaseModel
from fastapi.security import HTTPBasic, HTTPBasicCredentials
```

Импортируем необходимые компоненты, включая `FastAPI`, `Depends`, `status`, `HTTPException` и классы для работы с базовой аутентификацией — `HTTPBasic` и `HTTPBasicCredentials`.

**Шаг 2: Создайте приложение FastAPI и экземпляр HTTPBasic**

```python
app = FastAPI()
security = HTTPBasic()
```

Создаем приложение **FastAPI** и экземпляр `HTTPBasic`, который будет использоваться для извлечения учетных данных из запросов.

**Шаг 3: Создайте модель пользователя**

```python
class User(BaseModel):
    username: str
    password: str

# Симуляция базы данных в виде списка объектов пользователей
USER_DATA = [
    User(**{"username": "user1", "password": "pass1"}),
    User(**{"username": "user2", "password": "pass2"})
]
```

Здесь создается модель `User`, описывающая структуру данных пользователя, и простая симуляция базы данных в виде списка объектов.

**Шаг 4: Определите функцию аутентификации**

```python
def authenticate_user(credentials: HTTPBasicCredentials = Depends(security)):
    user = get_user_from_db(credentials.username)
    if user is None or user.password != credentials.password:
        raise HTTPException(status_code=status.HTTP_401_UNAUTHORIZED, detail="Invalid credentials")
    return user
```

Функция `authenticate_user` получает учетные данные из запроса через механизм зависимостей **FastAPI**. Если пользователь не найден или введенный пароль не совпадает с сохраненным, выбрасывается исключение с кодом `401 (Unauthorized)`.

**Шаг 5: Задайте логику получения информации о пользователе**

```python
def get_user_from_db(username: str):
    for user in USER_DATA:
        if user.username == username:
            return user
    return None
```

Функция `get_user_from_db` ищет пользователя по имени в нашей симулированной базе данных. Если пользователь найден, функция возвращает его объект; если нет — возвращает `None`.

**Шаг 6: Защитите конечные точки с помощью аутентификации**

```python
@app.get("/protected_resource/")
def get_protected_resource(user: User = Depends(authenticate_user)):
    return {"message": "You have access to the protected resource!", "user_info": user}
```

В данном шаге мы защищаем конечную точку `/protected_resource/`. При каждом запросе к этому ресурсу **FastAPI** сначала выполнит функцию `authenticate_user` для проверки учетных данных, используя механизм зависимости через `Depends(authenticate_user)`. Если аутентификация пройдена успешно, пользователь получает доступ к защищенному ресурсу.

### Разбор работы `Depends`

Класс `Depends` говорит обработчику маршрута, что перед выполнением основного кода маршрута нужно сначала обработать зависимость. В него передается объект, который можно вызвать (обычно это функция, но может быть и класс с методом `__call__`). Например:

```python
def my_dependency():
    return "Зависимость выполнена"

@app.get("/")
def read_root(data=Depends(my_dependency)):
    return {"message": data}
```

В этом примере `my_dependency` вызывается автоматически перед выполнением `read_root`, а её результат передается в параметр `data`.

В нашем коде мы используем `Depends(authenticate_user)`. **FastAPI** перед выполнением маршрута `/protected_resource/` вызывает функцию `authenticate_user`, но эта функция сама имеет зависимость — `security`, являющийся экземпляром `HTTPBasic()`. Этот класс проверяет заголовок `Authorization`, сверяет схему аутентификации `(Basic)` и учетные данные. Если они отсутствуют или неверны — выдается ошибка. Если всё корректно, то логин и пароль передаются в `authenticate_user`, который уже проверяет пользователя в нашей базе.

## Соображения безопасности

**Базовая аутентификация** — это простой и удобный способ реализации аутентификации, но у нее есть серьезные ограничения с точки зрения безопасности. Основная проблема заключается в том, что учетные данные (имя пользователя и пароль) передаются в запросах в виде обычного текста, что делает их уязвимыми для перехвата. Особенно это опасно при использовании незащищенных соединений (например, без `HTTPS`).

Чтобы повысить безопасность, следует рассмотреть более защищенные способы аутентификации. Одним из таких является аутентификация на основе `JWT (JSON Web Token)`, которая позволяет безопасно передавать информацию о пользователе в виде токенов, которые могут быть проверены на сервере. Еще один популярный вариант — интеграция с внешними поставщиками аутентификации, такими как `OAuth`, который обеспечивает более сложные механизмы безопасности, например, аутентификацию через `Google` или `Facebook`.

На данном занятии мы рассмотрели, как реализовать базовую аутентификацию в **FastAPI**. Мы изучили, как работает базовая аутентификация, и пошагово внедрили ее в приложение для защиты определенной конечной точки. Однако, учитывая ограничения этого метода, не забывайте тщательно подходить к вопросам безопасности в реальных приложениях. 

